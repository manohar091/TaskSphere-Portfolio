name: ğŸš€ TaskSphere CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: tasksphere
  ECS_SERVICE: tasksphere-service
  ECS_CLUSTER: tasksphere-cluster

jobs:
  # ğŸ§ª Test & Quality Check
  test:
    name: ğŸ§ª Test & Quality Assurance
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root123
          MYSQL_DATABASE: tasksphere_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
      
      redis:
        image: redis:7.0
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ğŸ“¦ Cache Maven Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ§ª Run Unit Tests
      run: |
        cd backend
        ./mvnw clean test -Dspring.profiles.active=test
    
    - name: ğŸ” Run Integration Tests
      run: |
        cd backend
        ./mvnw verify -Dspring.profiles.active=test
    
    - name: ğŸ“Š Generate Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: backend/target/surefire-reports/*.xml
        reporter: java-junit

    - name: ğŸ“ˆ Code Coverage
      run: |
        cd backend
        ./mvnw jacoco:report
    
    - name: ğŸ“¤ Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/target/site/jacoco/jacoco.xml

  # ğŸ—ï¸ Build & Push Docker Image
  build:
    name: ğŸ—ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    outputs:
      image: ${{ steps.image.outputs.image }}

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: ğŸ“¦ Cache Maven Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ğŸ”¨ Build Application
      run: |
        cd backend
        ./mvnw clean package -DskipTests -Dspring.profiles.active=prod

    - name: ğŸ·ï¸ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸ” Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: ğŸ³ Build, Tag, and Push Docker Image
      id: image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Build Docker image
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG backend/
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Push to ECR
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # Output image URI
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  # ğŸš€ Deploy to AWS
  deploy:
    name: ğŸš€ Deploy to AWS EC2
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ·ï¸ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ğŸš€ Deploy to ECS
      run: |
        # Update ECS service with new image
        aws ecs update-service \
          --cluster $ECS_CLUSTER \
          --service $ECS_SERVICE \
          --force-new-deployment

    - name: â³ Wait for Deployment
      run: |
        aws ecs wait services-stable \
          --cluster $ECS_CLUSTER \
          --services $ECS_SERVICE

    - name: ğŸ©º Health Check
      run: |
        # Wait for deployment and check health
        sleep 60
        curl -f https://api.tasksphere.app/actuator/health || exit 1

  # ğŸ” Security Scan
  security:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Run OWASP ZAP Scan
      uses: zaproxy/action-full-scan@v0.4.0
      with:
        target: 'http://localhost:8081'
        
    - name: ğŸ›¡ï¸ Run Snyk Security Scan
      uses: snyk/actions/maven@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

  # ğŸ“Š Performance Testing
  performance:
    name: ğŸ“Š Performance Testing
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸš€ Run Load Tests
      run: |
        # Install Apache Bench for load testing
        sudo apt-get update
        sudo apt-get install apache2-utils
        
        # Run load test
        ab -n 1000 -c 10 https://api.tasksphere.app/actuator/health
        
    - name: ğŸ“ˆ Performance Report
      run: |
        echo "Load test completed successfully"

  # ğŸ“¢ Notification
  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [test, build, deploy, security, performance]
    if: always()
    
    steps:
    - name: ğŸ’¬ Slack Notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          ğŸš€ TaskSphere Deployment Status: ${{ job.status }}
          ğŸ“Š Tests: ${{ needs.test.result }}
          ğŸ—ï¸ Build: ${{ needs.build.result }}
          ğŸš€ Deploy: ${{ needs.deploy.result }}
          ğŸ” Security: ${{ needs.security.result }}
          ğŸ“ˆ Performance: ${{ needs.performance.result }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}